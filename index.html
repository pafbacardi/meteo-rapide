<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√©t√©o rapide !</title>
    <style>
        /* Variables CSS par d√©faut (pour le th√®me initial/fallback) */
        body {
            --main-bg: #e0f7fa;
            --main-text: #333;
            --header-text: #4A148C;
            --section-text: #6A1B9A;
            --card-bg: #F3E5F5;
            --button-bg: #8E24AA;
            --button-text: white;
            --input-border: #B39DDB;
            --select-bg: #f3e5f5;
            --select-text: #4A148C;
            --city-option-bg: #90CAF9;
            --temp-color: #D84315;
            --precipitation-color: #00838f;
            --feels-like-color: #8D6E63;
            --input-section-bg: #EDE7F6;

            font-family: 'Comic Sans MS', cursive, sans-serif;
            text-align: center;
            margin: 10px; /* Marges r√©duites pour mobile */
            overflow-x: hidden; /* Emp√™che le d√©filement horizontal */

            background-color: var(--main-bg);
            color: var(--main-text);
            transition: background-color 0.8s ease, color 0.8s ease; /* Transition douce */
        }

        /* Application des variables aux √©l√©ments */
        h1 { color: var(--header-text); }
        #current-location-display { color: var(--header-text); }
        .section-title { color: var(--section-text); border-bottom-color: var(--section-text); }
        .weather-card { background-color: var(--card-bg); }
        .day-card { background-color: var(--card-bg); }
        .weather-button { background-color: var(--button-bg); color: var(--button-text); }
        /* Le bouton "Retour Charvieu" garde sa couleur sp√©cifique */
        #btn-back-to-charvieu { background-color: #FFC107; color: #333; }
        .location-input-section { background-color: var(--input-section-bg); }
        .location-input-section input[type="text"] { border-color: var(--input-border); }
        .location-input-section button { background-color: var(--button-bg); color: var(--button-text); }
        select { background-color: var(--select-bg); color: var(--select-text); border-color: var(--input-border); }
        #city-selection-results { background-color: var(--card-bg); border-color: var(--input-border); }
        .city-option-button { background-color: var(--city-option-bg); color: var(--button-text); }
        .error-message { color: #e53935; } /* La couleur d'erreur reste rouge */
        .temp { color: var(--temp-color); }
        .temp-range { color: var(--temp-color); }
        .precipitation { color: var(--precipitation-color); }
        .feels-like { color: var(--feels-like-color); }


        /* Th√®mes de couleurs sp√©cifiques */
        .theme-sunny {
            --main-bg: #ffe082; /* Jaune doux */
            --main-text: #333;
            --header-text: #D84315; /* Orange plus vif */
            --section-text: #FF6F00; /* Orange */
            --card-bg: #fff9c4; /* Jaune tr√®s clair */
            --button-bg: #FFB300; /* Jaune orange */
            --button-text: #333;
            --input-border: #FFD54F;
            --select-bg: #fff9c4;
            --select-text: #333;
            --city-option-bg: #FFECB3;
            --temp-color: #E65100;
            --precipitation-color: #2196F3; /* Bleu pour la pluie sur fond ensoleill√© */
            --feels-like-color: #BF360C;
            --input-section-bg: #FFF8E1;
        }

        .theme-cloudy {
            --main-bg: #cfd8dc; /* Gris bleu√¢tre doux */
            --main-text: #333;
            --header-text: #455A64; /* Gris fonc√© */
            --section-text: #607D8B; /* Gris */
            --card-bg: #eceff1; /* Gris tr√®s clair */
            --button-bg: #78909C; /* Gris bleu */
            --button-text: white;
            --input-border: #90A4AE;
            --select-bg: #eceff1;
            --select-text: #333;
            --city-option-bg: #B0BEC5;
            --temp-color: #BF360C;
            --precipitation-color: #00838f;
            --feels-like-color: #546E7A;
            --input-section-bg: #CFD8DC;
        }

        .theme-rainy {
            --main-bg: #a7c0d8; /* Bleu gris de pluie */
            --main-text: #333;
            --header-text: #1A237E; /* Bleu tr√®s fonc√© */
            --section-text: #283593; /* Bleu fonc√© */
            --card-bg: #e3f2fd; /* Bleu tr√®s tr√®s clair */
            --button-bg: #42A5F5; /* Bleu */
            --button-text: white;
            --input-border: #64B5F6;
            --select-bg: #e3f2fd;
            --select-text: #333;
            --city-option-bg: #90CAF9;
            --temp-color: #0D47A1;
            --precipitation-color: #004D40; /* Bleu-vert fonc√© */
            --feels-like-color: #3F51B5;
            --input-section-bg: #BBDEFB;
        }

        .theme-snowy {
            --main-bg: #e0f2f7; /* Blanc bleu√¢tre de neige */
            --main-text: #333;
            --header-text: #263238; /* Gris tr√®s fonc√© */
            --section-text: #455A64; /* Gris fonc√© */
            --card-bg: #f5f5f5; /* Presque blanc */
            --button-bg: #64B5F6; /* Bleu clair */
            --button-text: white;
            --input-border: #90CAF9;
            --select-bg: #f5f5f5;
            --select-text: #333;
            --city-option-bg: #BBDEFB;
            --temp-color: #1976D2;
            --precipitation-color: #0D47A1;
            --feels-like-color: #42A5F5;
            --input-section-bg: #E1F5FE;
        }

        .theme-thunderstorm {
            --main-bg: #8d6e63; /* Marron fonc√© pour l'orage */
            --main-text: #eee; /* Texte clair */
            --header-text: #FFCC80; /* Orange clair */
            --section-text: #FFAB40; /* Orange */
            --card-bg: #4e342e; /* Marron tr√®s fonc√© */
            --button-bg: #FF7043; /* Orange vif */
            --button-text: white;
            --input-border: #FF8A65;
            --select-bg: #4e342e;
            --select-text: #eee;
            --city-option-bg: #BF360C;
            --temp-color: #FFEB3B; /* Jaune vif */
            --precipitation-color: #BDBDBD; /* Gris */
            --feels-like-color: #FFAB40;
            --input-section-bg: #5D4037;
        }

        .theme-mist {
            --main-bg: #b0bec5; /* Gris brume */
            --main-text: #333;
            --header-text: #546E7A; /* Gris bleu fonc√© */
            --section-text: #78909C; /* Gris bleu */
            --card-bg: #cfd8dc; /* Gris bleu√¢tre doux */
            --button-bg: #90A4AE; /* Gris */
            --button-text: white;
            --input-border: #B0BEC5;
            --select-bg: #cfd8dc;
            --select-text: #333;
            --city-option-bg: #DCE7EB;
            --temp-color: #607D8B;
            --precipitation-color: #455A64;
            --feels-like-color: #78909C;
            --input-section-bg: #B0BEC5;
        }

        .theme-night {
            --main-bg: #263238; /* Bleu tr√®s fonc√©/presque noir */
            --main-text: #e0f2f7; /* Texte tr√®s clair */
            --header-text: #BBDEFB; /* Bleu clair */
            --section-text: #90CAF9; /* Bleu moyen */
            --card-bg: #37474F; /* Gris fonc√© */
            --button-bg: #42A5F5; /* Bleu */
            --button-text: white;
            --input-border: #64B5F6;
            --select-bg: #37474F;
            --select-text: #e0f2f7;
            --city-option-bg: #5C6BC0;
            --temp-color: #FFD54F; /* Jaune clair */
            --precipitation-color: #BBDEFB;
            --feels-like-color: #90CAF9;
            --input-section-bg: #455A64;
        }

        /* Nouvelle section pour l'en-t√™te principal */
        .main-header-section {
            display: flex;
            flex-direction: column; /* Par d√©faut, les √©l√©ments s'empilent sur mobile */
            align-items: center;
            justify-content: center;
            gap: 10px; /* Espacement entre les blocs */
            margin-bottom: 20px;
            padding: 10px;
            background-color: #ffffff;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .header-content-left {
            display: flex;
            flex-direction: column;
            align-items: center; /* Centr√© sur mobile */
            text-align: center; /* Centr√© sur mobile */
            flex-grow: 1; /* Prend l'espace disponible sur desktop */
        }
        h1 {
            font-size: 1.8em; /* Plus petit pour mobile */
            margin-bottom: 5px; /* Moins d'espace */
        }
        #current-location-display {
            font-size: 1.5em; /* Plus petit pour mobile */
            font-weight: bold;
            margin-bottom: 10px;
        }

        .button-container {
            display: flex;
            flex-direction: column; /* Boutons empil√©s par d√©faut sur mobile */
            gap: 10px; /* Espacement entre les boutons */
            margin-bottom: 10px;
        }
        
        /* Styles pour la carte */
        #map-container {
            width: 150px; /* Largeur fixe pour la carte sur mobile */
            height: 150px; /* Hauteur fixe pour la carte sur mobile */
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-top: 10px; /* Espacement au-dessus de la carte sur mobile */
        }
        #map-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .container {
            background-color: #ffffff;
            border-radius: 15px;
            padding: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-width: 100%;
            margin: 10px auto;
        }
        
        /* Styles sp√©cifiques pour le layout 4x6 (hourly) */
        .hourly-forecast {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            justify-content: center;
            padding: 5px;
            box-sizing: border-box;
        }

        .weather-card {
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            text-align: center;
            font-size: 0.8em;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80px;
            box-sizing: border-box;
        }
        /* Style pour les emojis m√©t√©o */
        .weather-emoji {
            font-size: 2.5em; /* Grande taille pour les emojis */
            line-height: 1; /* Assure que l'emoji ne prend pas trop de hauteur */
            margin-bottom: 2px; /* Petit espace sous l'emoji */
        }
        .weather-card p {
            margin: 2px 0;
            line-height: 1.2;
        }
        
        /* Styles pour la frise de pluie minute par minute (minutely) */
        .minutely-forecast-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 15px;
            padding: 8px;
            background-color: #f0f8ff;
            border-radius: 10px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
        }
        .minutely-timeline {
            display: flex;
            width: 100%;
            height: 30px;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 3px;
        }
        .minute-block {
            flex-grow: 1;
            height: 100%;
            background-color: #e0f7fa;
            transition: background-color 0.3s ease;
            border-right: 1px solid rgba(255,255,255,0.2);
        }
        .minute-block:last-child {
            border-right: none;
        }
        .timeline-labels {
            position: relative; /* Parent pour le positionnement absolu des labels */
            width: 100%; /* Prend toute la largeur disponible */
            height: auto; /* Hauteur ajust√©e au contenu */
            font-size: 0.65em;
            color: #555;
        }
        .timeline-label {
            position: absolute; /* Positionnement absolu */
            top: 0; /* Align√© en haut du conteneur des labels */
            white-space: nowrap; /* Emp√™che le texte de passer √† la ligne */
        }

        /* Styles pour les pr√©visions journali√®res (daily) */
        .daily-forecast {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
            padding: 5px;
            box-sizing: border-box;
        }
        .day-card {
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            text-align: center;
            font-size: 0.85em;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100px;
            box-sizing: border-box;
        }
        /* Style pour les emojis m√©t√©o dans les cartes journali√®res */
        .day-card .weather-emoji {
            font-size: 2.5em; /* Grande taille pour les emojis */
            line-height: 1;
            margin-bottom: 2px;
        }

        /* Styles pour la section de saisie de lieu (inchang√©s) */
        .location-input-section {
            background-color: var(--input-section-bg); /* Utilise la variable */
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .location-input-section input[type="text"] {
            padding: 10px;
            font-size: 1.1em;
            width: 80%;
            max-width: 300px;
        }
        
        /* Styles pour la liste de s√©lection de villes (inchang√©s) */
        #city-selection-results {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
        }
        
        /* Media queries pour les √©crans plus grands (desktop) */
        @media (min-width: 768px) {
            body {
                margin: 20px;
            }
            .main-header-section {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                padding: 15px 20px;
            }
            .header-content-left {
                align-items: center;
                text-align: center;
                flex-grow: 1;
                padding-right: 20px;
            }
            h1 { font-size: 2.5em; margin-bottom: 10px; }
            #current-location-display { font-size: 1.8em; margin-bottom: 15px; }

            .button-container {
                flex-direction: row;
                gap: 15px;
                margin-bottom: 0;
            }
            .weather-button {
                padding: 12px 25px;
                font-size: 1.2em;
            }

            #map-container {
                width: 200px;
                height: 200px;
                margin-top: 0;
                flex-shrink: 0;
            }

            .container { padding: 20px; }
            .section-title { font-size: 1.8em; margin-top: 30px; }

            .hourly-forecast {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 10px;
                padding: 10px;
            }
            .weather-card {
                padding: 15px;
                font-size: 1.1em;
                min-height: 90px;
            }
            /* Ajustement pour les emojis sur desktop */
            .weather-card .weather-emoji {
                font-size: 3em; /* Plus grande taille pour les emojis sur desktop */
            }
            .weather-card p { margin: 5px 0; } /* R√©initialise les marges pour desktop */
            .weather-card .temp { font-size: 1.4em; }
            .weather-card .feels-like { font-size: 0.9em; }
            .weather-card .time { font-size: 0.9em; }
            .weather-card .precipitation { font-size: 0.9em; }

            .minutely-forecast-container { padding: 10px; margin-top: 20px; }
            .minutely-timeline { height: 40px; margin-bottom: 5px; }
            .timeline-labels { font-size: 0.8em; }

            .daily-forecast {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: 15px;
                margin-top: 20px;
            }
            .day-card {
                padding: 15px;
                font-size: 0.9em;
                min-height: 120px;
            }
            /* Ajustement pour les emojis sur desktop */
            .day-card .weather-emoji {
                font-size: 3em; /* Plus grande taille pour les emojis sur desktop */
            }
            .day-card .temp-range { font-size: 1.3em; }
            .day-card .feels-like { font-size: 0.9em; }
            .day-card .date { font-size: 0.9em; }
        }
    </style>
</head>
<body>
    <div class="main-header-section">
        <div class="header-content-left">
            <h1>M√©t√©o rapide ! ‚òÄÔ∏è‚òÅÔ∏è‚òî</h1>
            <div id="current-location-display">Chargement...</div>
            <div class="button-container">
                <button id="btn-locate-me" class="weather-button">M√©t√©o ici ! üìç</button>
                <button id="btn-choose-location" class="weather-button">M√©t√©o ailleurs... üåç</button>
                <button id="btn-back-to-charvieu" class="weather-button">Retour Charvieu-Chavagneux üè†</button>
            </div>
        </div>
        <div id="map-container">
            <iframe id="map-iframe" src="" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
        </div>
    </div>

    <div id="location-input-section" class="location-input-section">
        <input type="text" id="city-input" placeholder="Tape le nom d'une ville (ex: Paris)">
        <button id="btn-search-location">Chercher !</button>
        <p id="location-error-message" class="error-message"></p>
        <div id="city-selection-results">
            <!-- Les options de ville seront ajout√©es ici -->
        </div>
    </div>

    <div class="container">
        <!-- Nouvelle section pour la frise de pluie minute par minute -->
        <h2 class="section-title">La pluie dans l'heure qui vient ! üíß</h2>
        <div id="minutely-forecast" class="minutely-forecast-container">
            <p class="error-message" id="minutely-loading">Chargement des pr√©visions de pluie minute par minute...</p>
            <!-- La frise sera ajout√©e ici par JavaScript -->
        </div>

        <h2 class="section-title">Les 24h √† venir ! ‚è∞</h2>
        <div id="hourly-forecast" class="hourly-forecast">
            <!-- La m√©t√©o heure par heure sera ajout√©e ici par JavaScript -->
            <p class="error-message" id="hourly-loading">Chargement de la m√©t√©o heure par heure...</p>
        </div>

        <h2 class="section-title">Les jours suivants (J+1 √† J+7) ! üóìÔ∏è</h2>
        <div id="daily-forecast" class="daily-forecast">
            <!-- Les cartes de m√©t√©o journali√®re seront g√©n√©r√©es ici par JavaScript -->
        </div>
    </div>

    <script>
        const API_KEY = '51aebd101995305de8a90d128247bdad'; // Ta cl√© API OpenWeatherMap
        const DEFAULT_LAT = 45.7167; // Latitude de Charvieu-Chavagneux
        const DEFAULT_LON = 5.15;    // Longitude de Charvieu-Chavagneux
        const DEFAULT_LOCATION_NAME = 'Charvieu-Chavagneux';
        const LANG = 'fr';   // Langue des r√©sultats
        const UNITS = 'metric'; // Unit√©s m√©triques (Celsius)

        // √âl√©ments du DOM
        const body = document.body;
        const currentLocationDisplay = document.getElementById('current-location-display');
        const btnLocateMe = document.getElementById('btn-locate-me');
        const btnChooseLocation = document.getElementById('btn-choose-location');
        const btnBackToCharvieu = document.getElementById('btn-back-to-charvieu');
        const locationInputSection = document.getElementById('location-input-section');
        const cityInput = document.getElementById('city-input');
        const btnSearchLocation = document.getElementById('btn-search-location');
        const locationErrorMessage = document.getElementById('location-error-message');
        const citySelectionResults = document.getElementById('city-selection-results');
        const mapIframe = document.getElementById('map-iframe');

        // Fonction pour obtenir les ic√¥nes m√©t√©o (maintenant des emojis)
        function getWeatherIcon(iconCode) {
            switch(iconCode) {
                case "01d": return "‚òÄÔ∏è"; // Clear sky (day)
                case "01n": return "üåô"; // Clear sky (night)
                case "02d": return "üå§Ô∏è"; // Few clouds (day)
                case "02n": return "‚òÅÔ∏èüåô"; // Few clouds (night)
                case "03d":
                case "03n": return "‚òÅÔ∏è"; // Scattered clouds
                case "04d":
                case "04n": return "‚òÅÔ∏è‚òÅÔ∏è"; // Broken clouds / Overcast
                case "09d":
                case "09n": return "üåßÔ∏è"; // Shower rain
                case "10d":
                case "10n": return "‚òî"; // Rain
                case "11d":
                case "11n": return "‚õàÔ∏è"; // Thunderstorm
                case "13d":
                case "13n": return "‚ùÑÔ∏è"; // Snow
                case "50d":
                case "50n": return "üå´Ô∏è"; // Mist
                default: return "‚ùì"; // Default icon
            }
        }

        // Fonction pour d√©terminer la classe de th√®me en fonction de l'ic√¥ne OpenWeatherMap
        function getThemeClass(iconCode) {
            const isDay = iconCode.endsWith('d');
            const baseIcon = iconCode.slice(0, -1); // e.g., "01" from "01d"

            switch (baseIcon) {
                case "01": return isDay ? "theme-sunny" : "theme-night";
                case "02": return isDay ? "theme-cloudy" : "theme-night"; // Few clouds, can be similar to night theme
                case "03": return "theme-cloudy";
                case "04": return "theme-cloudy"; // Overcast is still cloudy
                case "09": return "theme-rainy";
                case "10": return "theme-rainy";
                case "11": return "theme-thunderstorm";
                case "13": return "theme-snowy";
                case "50": return "theme-mist";
                default: return "theme-sunny"; // Fallback
            }
        }

        // Fonction pour appliquer le th√®me
        function applyTheme(themeClassName) {
            // Supprime toutes les classes de th√®me existantes
            const themeClasses = [
                "theme-sunny", "theme-cloudy", "theme-rainy", "theme-snowy",
                "theme-thunderstorm", "theme-mist", "theme-night"
            ];
            themeClasses.forEach(cls => body.classList.remove(cls));
            
            // Ajoute la nouvelle classe de th√®me
            body.classList.add(themeClassName);
        }

        // Fonction pour formater l'heure (ex: 14h00)
        function formatTime(timestamp) {
            const date = new Date(timestamp * 1000);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}h${minutes}`;
        }

        // Fonction pour formater la date (ex: Mer. 5 juil.)
        function formatDate(timestamp) {
            const date = new Date(timestamp * 1000);
            const options = { weekday: 'short', day: 'numeric', month: 'short' };
            return date.toLocaleDateString('fr-FR', options);
        }

        // Fonction principale pour r√©cup√©rer et afficher la m√©t√©o
        async function updateWeatherForLocation(lat, lon, locationName) {
            currentLocationDisplay.textContent = `${locationName}`;
            // Mettre √† jour la carte
            mapIframe.src = `https://maps.google.com/maps?q=${lat},${lon}&z=10&output=embed`;

            // Afficher les messages de chargement
            document.getElementById('minutely-forecast').innerHTML = '<p class="error-message" id="minutely-loading">Chargement des pr√©visions de pluie minute par minute...</p>';
            document.getElementById('hourly-forecast').innerHTML = '<p class="error-message" id="hourly-loading">Chargement de la m√©t√©o heure par heure...</p>';
            document.getElementById('daily-forecast').innerHTML = '<p class="error-message" id="daily-loading">Chargement des pr√©visions des prochains jours...</p>';
            locationErrorMessage.textContent = ''; // Cacher les erreurs pr√©c√©dentes
            citySelectionResults.innerHTML = ''; // Cacher les r√©sultats de s√©lection de ville
            citySelectionResults.style.display = 'none';

            // Modifier l'URL pour inclure les donn√©es "current" pour le th√®me
            const url = `https://api.openweathermap.org/data/3.0/onecall?lat=${lat}&lon=${lon}&exclude=alerts&appid=${API_KEY}&units=${UNITS}&lang=${LANG}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Erreur HTTP ! Statut: ${response.status}`);
                }
                const data = await response.json();
                console.log(data);

                // Appliquer le th√®me bas√© sur la m√©t√©o actuelle
                if (data.current && data.current.weather && data.current.weather.length > 0) {
                    const currentIconCode = data.current.weather[0].icon;
                    const themeClassName = getThemeClass(currentIconCode);
                    applyTheme(themeClassName);
                } else {
                    // Fallback au th√®me ensoleill√© si pas de donn√©es actuelles
                    applyTheme("theme-sunny");
                }

                displayMinutelyForecast(data.minutely); 
                displayHourlyForecast(data.hourly);
                displayDailyForecast(data.daily);
            } catch (error) {
                console.error('Probl√®me pour r√©cup√©rer les donn√©es m√©t√©o :', error);
                document.getElementById('minutely-forecast').innerHTML = '<p class="error-message">Impossible de charger la frise de pluie. V√©rifie la connexion ou la cl√© API.</p>';
                document.getElementById('hourly-forecast').innerHTML = '<p class="error-message">Oh non ! Je n\'arrive pas √† trouver la m√©t√©o pour le moment. Demande √† un adulte de v√©rifier ma connexion Internet ou ma cl√© m√©t√©o !</p>';
                document.getElementById('daily-forecast').innerHTML = '';
                currentLocationDisplay.textContent = `M√©t√©o pour ${locationName} (Erreur)`;
                applyTheme("theme-cloudy"); // Applique un th√®me neutre en cas d'erreur
            }
        }

        // --- Afficher la frise de pluie minute par minute ---
        function displayMinutelyForecast(minutelyData) {
            const minutelyContainer = document.getElementById('minutely-forecast');
            minutelyContainer.innerHTML = '';

            if (!minutelyData || minutelyData.length === 0) {
                minutelyContainer.innerHTML = '<p class="precipitation">Pas de pr√©visions de pluie minute par minute disponibles pour le moment.</p>';
                return;
            }

            const timelineDiv = document.createElement('div');
            timelineDiv.className = 'minutely-timeline';
            
            for (let i = 0; i < 60; i++) {
                const minute = minutelyData[i];
                if (!minute) continue;

                const precipitation = minute.precipitation;
                let backgroundColor = '#e0f7fa'; 

                if (precipitation > 0 && precipitation <= 0.5) {
                    backgroundColor = '#bbdefb';
                } else if (precipitation > 0.5 && precipitation <= 2) {
                    backgroundColor = '#90caf9';
                } else if (precipitation > 2 && precipitation <= 5) {
                    backgroundColor = '#64b5f6';
                } else if (precipitation > 5) {
                    backgroundColor = '#42a5f5';
                }

                const minuteBlock = document.createElement('div');
                minuteBlock.className = 'minute-block';
                minuteBlock.style.backgroundColor = backgroundColor;
                minuteBlock.title = `Dans ${i} min : ${precipitation.toFixed(1)} mm/h`;
                timelineDiv.appendChild(minuteBlock);
            }
            minutelyContainer.appendChild(timelineDiv);

            const labelsDiv = document.createElement('div');
            labelsDiv.className = 'timeline-labels';
            const now = new Date();

            for (let i = 0; i <= 60; i += 10) {
                const labelSpan = document.createElement('span');
                labelSpan.className = 'timeline-label';
                
                const positionPercentage = (i / 60) * 100;
                labelSpan.style.left = `${positionPercentage}%`;

                if (i === 0) {
                    labelSpan.style.transform = 'translateX(0%)';
                    labelSpan.style.textAlign = 'left';
                } else if (i === 60) {
                    labelSpan.style.transform = 'translateX(-100%)';
                    labelSpan.style.textAlign = 'right';
                } else {
                    labelSpan.style.transform = 'translateX(-50%)';
                    labelSpan.style.textAlign = 'center';
                }

                const futureTime = new Date(now.getTime() + i * 60 * 1000);
                const hours = futureTime.getHours().toString().padStart(2, '0');
                const minutes = futureTime.getMinutes().toString().padStart(2, '0');
                labelSpan.textContent = `${hours}h${minutes}`;

                labelsDiv.appendChild(labelSpan);
            }
            minutelyContainer.appendChild(labelsDiv);
        }


        // --- Afficher la m√©t√©o heure par heure (les 24h √† venir) ---
        function displayHourlyForecast(hourlyData) {
            const hourlyContainer = document.getElementById('hourly-forecast');
            hourlyContainer.innerHTML = '';

            for (let i = 0; i < 24; i++) {
                const hour = hourlyData[i];
                if (!hour) continue;

                const rainVolume = hour.rain && hour.rain['1h'] ? hour.rain['1h'].toFixed(1) : '0';
                const snowVolume = hour.snow && hour.snow['1h'] ? hour.snow['1h'].toFixed(1) : '0';
                
                let precipitationInfo = '';
                if (parseFloat(rainVolume) > 0) {
                    precipitationInfo += `<p class="precipitation">Pluie: ${rainVolume} mm</p>`;
                }
                if (parseFloat(snowVolume) > 0) {
                    precipitationInfo += `<p class="precipitation">Neige: ${snowVolume} mm</p>`;
                }

                const card = `
                    <div class="weather-card">
                        <p class="time">${formatTime(hour.dt)}</p>
                        <span class="weather-emoji">${getWeatherIcon(hour.weather[0].icon)}</span>
                        <p class="temp">${Math.round(hour.temp)}¬∞C</p>
                        <p class="feels-like">Ressenti: ${Math.round(hour.feels_like)}¬∞C</p>
                        <p>${hour.weather[0].description}</p>
                        ${precipitationInfo}
                    </div>
                `;
                hourlyContainer.innerHTML += card;
            }
        }

        // --- Afficher les pr√©visions des jours J+1 √† J+7 ---
        function displayDailyForecast(dailyData) {
            const dailyContainer = document.getElementById('daily-forecast');
            dailyContainer.innerHTML = '';

            for (let i = 0; i < 7 && i < dailyData.length; i++) {
                const day = dailyData[i];
                if (!day) continue;

                const rainVolume = day.rain ? day.rain.toFixed(1) : '0';
                const snowVolume = day.snow ? day.snow.toFixed(1) : '0';

                let precipitationInfo = '';
                if (parseFloat(rainVolume) > 0) {
                    precipitationInfo += `<p class="precipitation">Pluie: ${rainVolume} mm</p>`;
                }
                if (parseFloat(snowVolume) > 0) {
                    precipitationInfo += `<p class="precipitation">Neige: ${snowVolume} mm</p>`;
                }

                const card = `
                    <div class="day-card">
                        <p class="date">${formatDate(day.dt)}</p>
                        <span class="weather-emoji">${getWeatherIcon(day.weather[0].icon)}</span>
                        <p class="temp-range">
                            ${Math.round(day.temp.min)}¬∞C √† ${Math.round(day.temp.max)}¬∞C
                        </p>
                        <p class="feels-like">Ressenti: ${Math.round(day.feels_like.day)}¬∞C</p>
                        <p>${day.weather[0].description}</p>
                        ${precipitationInfo}
                    </div>
                `;
                dailyContainer.innerHTML += card;
            }
        }

        // --- Gestion des √©v√©nements des boutons ---

        btnLocateMe.addEventListener('click', () => {
            currentLocationDisplay.textContent = "Recherche de ta position...";
            locationErrorMessage.textContent = '';
            locationInputSection.style.display = 'none';
            citySelectionResults.innerHTML = '';
            citySelectionResults.style.display = 'none';

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        getCityNameFromCoordinates(lat, lon).then(locationName => {
                            updateWeatherForLocation(lat, lon, locationName || "Ma position actuelle");
                        });
                    },
                    (error) => {
                        console.error('Erreur de g√©olocalisation :', error);
                        let errorMessage = 'Impossible de trouver ta position.';
                        if (error.code === error.PERMISSION_DENIED) {
                            errorMessage += '<br>V√©rifie les r√©glages de localisation de ton navigateur ou de ton t√©l√©phone (autorise l\'acc√®s √† la g√©olocalisation pour cette page).';
                            errorMessage += '<br>Assure-toi aussi que la page est ouverte via HTTPS (adresse qui commence par "https://").';
                        } else if (error.code === error.POSITION_UNAVAILABLE) {
                            errorMessage += '<br>La position n\'est pas disponible.';
                        } else if (error.code === error.TIMEOUT) {
                            errorMessage += '<br>Le temps de recherche de la position est √©coul√©.';
                        }
                        locationErrorMessage.innerHTML = errorMessage;
                        currentLocationDisplay.textContent = "Position inconnue";
                        updateWeatherForLocation(DEFAULT_LAT, DEFAULT_LON, DEFAULT_LOCATION_NAME);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                locationErrorMessage.textContent = 'Ton navigateur ne supporte pas la g√©olocalisation.';
                currentLocationDisplay.textContent = "Position inconnue";
                updateWeatherForLocation(DEFAULT_LAT, DEFAULT_LON, DEFAULT_LOCATION_NAME);
            }
        });

        async function getCityNameFromCoordinates(lat, lon) {
            const reverseGeocodingUrl = `https://api.openweathermap.org/geo/1.0/reverse?lat=${lat}&lon=${lon}&limit=1&appid=${API_KEY}`;
            try {
                const response = await fetch(reverseGeocodingUrl);
                const data = await response.json();
                if (data.length > 0) {
                    return data[0].name + (data[0].state ? `, ${data[0].state}` : '') + (data[0].country ? `, ${data[0].country}` : '');
                }
            } catch (error) {
                console.error('Erreur lors du g√©ocodage inverse :', error);
            }
            return null;
        }

        btnChooseLocation.addEventListener('click', () => {
            if (locationInputSection.style.display === 'flex') {
                locationInputSection.style.display = 'none';
                locationErrorMessage.textContent = '';
                citySelectionResults.innerHTML = '';
                citySelectionResults.style.display = 'none';
            } else {
                locationInputSection.style.display = 'flex';
                cityInput.value = '';
                cityInput.focus();
                locationErrorMessage.textContent = '';
                citySelectionResults.innerHTML = '';
                citySelectionResults.style.display = 'none';
            }
        });

        btnSearchLocation.addEventListener('click', async () => {
            const cityName = cityInput.value.trim();
            if (cityName === '') {
                locationErrorMessage.textContent = 'Tape le nom d\'une ville, s\'il te pla√Æt !';
                return;
            }

            locationErrorMessage.textContent = 'Recherche de la ville...';
            citySelectionResults.innerHTML = '';
            citySelectionResults.style.display = 'none';

            const geocodingUrl = `https://api.openweathermap.org/geo/1.0/direct?q=${cityName}&limit=5&appid=${API_KEY}`;

            try {
                const response = await fetch(geocodingUrl);
                if (!response.ok) {
                    throw new Error(`Erreur HTTP lors de la recherche de la ville ! Statut: ${response.status}`);
                }
                const data = await response.json();

                if (data.length > 1) {
                    locationErrorMessage.textContent = 'Plusieurs villes trouv√©es. Choisis celle que tu veux :';
                    citySelectionResults.style.display = 'flex';

                    data.forEach(city => {
                        const optionText = `${city.name}` + 
                                           (city.state ? `, ${city.state}` : '') + 
                                           (city.country ? `, ${city.country}` : '');
                        
                        const cityButton = document.createElement('button');
                        cityButton.className = 'city-option-button';
                        cityButton.textContent = optionText;
                        cityButton.addEventListener('click', () => {
                            updateWeatherForLocation(city.lat, city.lon, optionText);
                            locationInputSection.style.display = 'none';
                        });
                        citySelectionResults.appendChild(cityButton);
                    });

                } else if (data.length === 1) {
                    const lat = data[0].lat;
                    const lon = data[0].lon;
                    const foundCityName = data[0].name + 
                                          (data[0].state ? `, ${data[0].state}` : '') + 
                                          (data[0].country ? `, ${data[0].country}` : '');
                    updateWeatherForLocation(lat, lon, foundCityName);
                    locationInputSection.style.display = 'none';
                } else {
                    locationErrorMessage.textContent = `D√©sol√©, je n'ai pas trouv√© la ville "${cityName}". Essaie encore !`;
                }
            } catch (error) {
                console.error('Probl√®me lors de la recherche de la ville :', error);
                locationErrorMessage.textContent = 'Une erreur est survenue lors de la recherche de la ville.';
            }
        });

        btnBackToCharvieu.addEventListener('click', () => {
            updateWeatherForLocation(DEFAULT_LAT, DEFAULT_LON, DEFAULT_LOCATION_NAME);
            locationInputSection.style.display = 'none';
            citySelectionResults.innerHTML = '';
            citySelectionResults.style.display = 'none';
        });

        document.addEventListener('DOMContentLoaded', () => {
            updateWeatherForLocation(DEFAULT_LAT, DEFAULT_LON, DEFAULT_LOCATION_NAME);
        });
    </script>
</body>
</html>
